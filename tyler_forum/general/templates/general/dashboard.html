{% extends "index.html" %}
{% load static %}
{% block page-content %}
  <style>
.pointer{
  cursor:pointer;
}
.message-out{
  color: blue !important;
  width: 150px !important;
  height: 50px !important;
  background: #86c7ff !important;
  padding: 10px !important;
  border-radius: 50px !important;
  animation: Pop-up  1s ease-in !important;

}
.online-green{
  background:lightgreen;
  float:right !important;
  width:10px;
  height:10px;
  border-radius:50px;
  display:inline-block;
}
.offline-red{
 background:#ff1515;
  float:right !important;
  width:10px;
  height:10px;
  border-radius:50px;
  display:inline-block;
}
/* --- 1. The Main Chat Container --- */
#fk_msg {
    display: flex;              /* Enables Flexbox */
    flex-direction: column;     /* Stacks messages vertically (Top to Bottom) */
    gap: 10px;                  /* Space between bubbles */
    padding: 15px;
    
    /* Scroll settings */
    height: 350px;              /* Fixed height on Desktop */
    overflow-y: auto;           /* Scrollbar appears if messages overflow */
    scroll-behavior: smooth;    /* Smooth scrolling effect */
    
    /* Background (Optional) */
    background-color: #f5f5f5; 
}

/* --- 2. The Shared Bubble Style --- */
.chat-bubble {
    max-width: 75%;             /* Bubbles won't stretch full width */
    padding: 10px 15px;
    border-radius: 18px;        /* Rounded corners */
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;      /* Prevents long words from breaking layout */
    position: relative;
}

/* --- 3. YOUR Messages (Right Side) --- */
.hk_user {
    align-self: flex-end;       /* Pushes bubble to the RIGHT */
    background-color: #4CAF50;  /* Green */
    color: white;
    border-bottom-right-radius: 2px; /* Small corner detail */
    text-align: left;           /* Text inside stays left-aligned (easier to read) */
}

/* --- 4. FRIEND'S Messages (Left Side) --- */
.fk_user {
    align-self: flex-start;     /* Pushes bubble to the LEFT */
    background-color: #aeaeae;  /* Grey */
    color: black;
    border-bottom-left-radius: 2px; /* Small corner detail */
}

/* --- 5. Mobile View (The "Phone" Part) --- */
@media screen and (max-width: 600px) {
    /* On phone, make the chat box bigger or full width */
    #fk_msg {
        height: 60vh;           /* Use 60% of screen height */
        padding: 10px;          /* Less padding on small screens */
    }

    .chat-bubble {
        max-width: 85%;         /* Allow bubbles to be wider on phone */
        font-size: 16px;        /* Slightly larger text for readability */
    }
}
@keyframes Pop-up {
  from {
    top:100%;
  }to{
    top:0%;
  }
}
.card-msg{
  opacity:0;

}
.profile_photo{
  width: 50px;
  height: 50px;
  border-radius: 50%;
}
 </style>
    <div class='container'>
    
        {% include "general/header_footer/header.html"%}
<div class='row justify-content-center'>
  <!--CHAT CORNER-->
  <div class='col-sm-2'>
    <div id='chat-block'>
      <div class='bg-primary mt-2' style='background:#06518f !important;'><h5 class='text-white text-center'>Friends&nbsp;<i class='bi bi-globe'></i></h5>
      <ul class="list-group" id='lst_grp'></ul>
      </div>

    </div>

  </div>
  <!--BLOG CENTER-->
   <div class='col-sm-8 mt-2' style='height:550px;overflow-y:scroll;border-right: 1px solid #dee2e6;border-left:1px solid #dee2e6;'>
  {% for blog in blogs  %}
    
        {% if not blog %}
         <h4 class='text-danger'> No Posts are posted yet <h4>
        {% endif %}
      <div class='card mt-3'>
        <div class='card-title ms-3 text-primary'><h5 data-bs-toggle="dropdown">{{blog.blog_title}}<i class=' bi bi-three-dots float-end me-1' ></i></h5>
            <ul class='dropdown-menu'>
                  {% if user_id.id == blog.user_id.id %}
              <li><a class='dropdown-item' data-bs-target='#blog-modal' data-bs-toggle='modal' id="blog-edit" onclick="editPost('{{blog.id}}','blog_title','blog_content')">Edit</a></li>
              <li><a class='dropdown-item' data-bs-target="#blog-modal" data-bs-toggle="modal" id="blog-delete" onclick="deletePost('{{blog.id}}','blog_title','blog_content')">Delete</a></li>
                  {% else %}
                <li><a class="dropdown-item" onclick="seeOtherPost('{{blog.user_id.id}}','{{blog.user_id.first_name}}')">See&nbsp;{{blog.user_id.first_name}}&nbsp;Posts</a></li>
                <li><a class="dropdown-item">See&nbsp;{{blog.user_id.first_name}}&nbsp;Profile</a></li>
                <li><a class="dropdown-item" id='chat' onclick="loadChat('{{blog.user_id.id}}','{{blog.user_id.first_name}}')">See&nbsp;&nbsp;Message</a></li>
                  {% endif %}
            </ul>
        </div>
              <hr>
            <div class='card-body'>
                <p>{{blog.blog_content}}</p>
            </div>
          
            <div class='card-footer'>
                <a><i>Posted on&nbsp;{{blog.date_joined}}</i></a><br>
              <a>Posted by&nbsp;{{blog.user_id.first_name}}</a>
              <a class='float-end'>{% if blog.last_edited %}Edited {{blog.last_edited}}{% else %}Not Edited{% endif %}</a>
            </div>
      </div>
       {% endfor %}
  </div>
  <!--TOPIC AND DISCOVER-->
  <div class='col-sm-2'>
    <ul class='nav flex-column'>
      <li class='nav-item'><a class="nav-link active" aria-current="page" href="{% url "forum" %}"><i class="bi bi-house"></i>&nbsp;Home</a></li>
      <li class='nav-item dropdown '><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i class="bi bi-file-earmark-post"></i>&nbsp; post</a>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" data-bs-toggle='modal' data-bs-target="#blog-modal" style='color:rgb(6, 81, 143) !important;'>Post a blog</a>
                <a class="dropdown-item" style='color:rgb(6, 81, 143) !important;'>Your posts</a>
              </li>
            </ul></li>
      <li class='nav-item'><a class="nav-link active" aria-current="page" href="{% url "forum" %}"><i class="bi bi-chat-dots-fill"></i>&nbsp;Chat</a></li>
      <li class='nav-item dropdown'><a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
           <i class="bi bi-person-circle"></i>&nbsp; Bio
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" style='color:rgb(6, 81, 143) !important;'>{{user_id.first_name}}</a></li>
            <li><a class="dropdown-item" href="#" style='color:rgb(6, 81, 143) !important;'>{{user_id.email}}</a></li>
              <li><a class="dropdown-item " data-bs-toggle="modal" data-bs-target="#updateBio"  onclick="loadFormModal(1,1);"> <span class='btn btn-primary' type='button'>Update Bio</span></a>
                  
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><button class='btn btn-danger' id='logout'><i class='bi bi-power'></i> </button></li>
            <li><a class="dropdown-item"><i>version:Ty-1.1</i></a></li>
          </ul></li>
      <li class='nav-item'>  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-check"></i>&nbsp;verification
          </a>
          <ul class="dropdown-menu">
            {% if user_id.verify_email is 0 %}
                <li><a class="dropdown-item" href="#" style="color:rgb(6, 81, 143) !important;">{{user_id.email}}<span class='badge bg-danger'>Not-verified</span></a></li>
            {% endif %}</ul></li>
      <li class='nav-item'><a class="nav-link " aria-current="page" href="{% url "games" %}"><i class="bi bi-controller"></i>&nbsp;Game </a></li>
      <li Class='nav-item pointer '><a class='nav-link dropdown '  data-bs-toggle="dropdown">settings</a>
        <ul class='dropdown-menu'>
        <li class='dropdown-item'><a> data insights</a></li>
        <li class='dropdown-item'><a> Time Spent</a></li>
        <li class='dropdown-item'><a>Preferences</a></li>
      </ul></li>
      
    </ul>
  </div>
  <!---MESSAGE BLOCK-->
  <div class="row mt-3">
    <div class='col-sm-4 '>
      <div id='load message '>
        <div class='card card-msg'>
        <div class='card-header' style='color:white;background:#06518f' id=''>
          <div class='row'><div class='col-sm-9'><span id='image'><img src="{% static 'logo/images/coat_suit.png' %}" class='profile_photo'></span><span id='message_headbar' class='ms-2'></span></div><div class='col-sm-3'><i class='bi bi-x bi-close' style='float:right;font-size:20px;cursor:pointer' onclick="toggle()" id='close_btn'></i></div></div></div>
        <div class='card-body' style="height:250px;background:#f9f6f6 !important;overflow-y:scroll;">
              <div class='row'>
                <div class='col-6'>
                  <div id='fk_msg'>
                </div>
              </div>
              <div class='col-6'>
              <div id="hk_msg"></div>
            </div>
          </div>
          </div>
        
        <div class='card-footer'>
          <form class='' id='messageTextForm'>
            <div class='row mt-3'>
            <div class='col-sm-9'><textarea class='form-control' id='mess_1'></textarea></div>
            <input type='hidden' id='fk_id' value=''>
            <div class='col-sm-3 mt-2'><span class='btn btn-primary' onclick="sendMessage('mess_1')">Send</span></div></div></div>
            {% csrf_token %}
          </form>
        </div>
      </div>
    </div>
  </div>

      </div>
  
<div>
    <!--BLOG MODAL-->
  <div class="modal" tabindex="-1" id='blog-modal'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Post a blog</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id='form-modal' class='form-horizontal' onsubmit="return false">
        

        </form>
           <div id='response-blog'></div>
      </div>
      <div class="modal-footer">
        <div>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">cancel post</button>
        <button type="button" class="btn btn-primary" id='postBlog'>Upload Post</button></div>

      </div>
    </div>
  </div>
</div>


    <!--Modal Ends-->
    <div class="modal"  id="update-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        Update Bio
                    </div>
                    <div class="modal-content" id="modal-content">
                        
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary">Update</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  <div class="modal" tabindex="-1" id='modal-search'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Your Search Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
       <ul class="list-group" id="response-list">

        
       </ul>          
      </div>
      <div class="modal-footer">
        <div>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">close</button>
        

      </div>
    </div>
  </div>
    
    <div id='response'></div></div>
     
      </div>
    <!--UPDATE BIO-->
    <div class="modal fade" id="updateBio" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id='update-bio'>
        
       
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="editFormLoad(1)">Edit</button>
        <button type="button" class="btn btn-primary" onclick="editFormLoad(2)">Save changes</button>
        
      </div>
    </div>
  </div>
</div>
 
{% endblock page-content %}
{% block page-script %}

<script src="{% static 'js/dasbuild.js'%}"></script>
<script>
let time = 1000; 
const element = document.getElementById("referesh_cnt");

// 2. Use 'setInterval' to make it loop
var countdown = setInterval(function() {
  
  time--;
  
  // 3. Correct spelling is 'innerHTML'
  // I changed '+=' to '=' so it shows the number counting down clearly
  element.innerHTML = "Refreshing in: " + time; 

  if(time == 0) {
    // Stop the timer so it doesn't go to -1, -2, etc.
    clearInterval(countdown);
    window.location.href('/api/forum')
  }
  
}, 1000)

  friends_list()
    class formsLoad
    {
        constructor(first_name,last_name,email_id)
        {
            this.first_name=first_name;
            this.last_name=last_name;
            this.email_id= email_id

        }
        get_form()
        {
          let form_storage=[this.first_name,this.last_name,this.email_id];
          let input_type=["text","text","email"];
          for(let i=0;i<=input_type.length;i++){
            console.log(form_storage[i]);
          }
        }

    }
let load_name= new formsLoad("{{user_id.first_name}}","{{user_id.last_name}}","{{user_id.email}}");
console.log(load_name.get_form());

   function loads(){
            let blog_form=["text",];
            let blog_input=["Blog title"]

            let blog_arr="";

            let i;
            for( i=0;i<blog_form.length;i++){
              blog_arr+="<div class='form-group'><label class='form-label'>"+blog_input[i]+"</label><input type='"+blog_form[i]+"' class='form-control' id='blog_title'value=''></div>"
            }
            $("#form-modal").html(blog_arr+"<div class='form-group'><label class='form-label'>Blog Content</label><textarea class='form-control' id='blog_content'></textarea></div><input type='hidden' id='token' value={{csrf_token}}><input type='hidden' value='' id='blog_id'><input type='hidden' value='false' id='edit_it'><input type='hidden' value='false' id='delete_it'>")
        }
          loads();
   
    $(document).ready(function(){
      
        $('#logout').click(function(){
            $.get('/api/logout',function(data){
                if(data.Message){
                    $("#response").html('<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>')
                setTimeout(function(){
                    window.location.href='/api/login'
                },2000);
                
                }else{
                    alert('Something Went Wrong');
                }
                
            });
        });
        //ON-POST...


          $("#postBlog").click(function(){
            let blog_title=$("#blog_title").val();
            let blog_content=$("#blog_content").val();
            let csrfmiddlewaretoken=$("#token").val()
            let blog_id=$('#blog_id').val();
            let edit_it=$("#edit_it").val();
            let delete_it=$("#delete_it").val();
            $.post('/api/blog_post',{blog_title:blog_title,blog_content:blog_content,csrfmiddlewaretoken:csrfmiddlewaretoken,edit_it:edit_it,blog_id:blog_id,delete_it:delete_it},function(data){
              $("#response-blog").html("<span class='text-success'>"+data.Message+"</span>");
              $("#response-blog").html("<span class='text-danger'>"+data.Error+"</span>");
            })
          });
      
       
    });
    //ON_EDIT
       function editPost(user_id,titleId,titleContent){
          let token=$('#token').val();
          $('#delete_it').val('false');
          $('#edit_it').val('true')
          $.get('/api/forum',{csrf_token:token,blog_id:user_id,edit:1},function(data){
              if(data.Message===true){
                $('#'+titleId).val(data.blog_title);
                $('#'+titleContent).text(data.blog_content)
                $("#postBlog").text('Edit Post')
                $("#edit_it").val("True")
                $("#blog_id").val(user_id)

              }else{
                $('#response-blog').html('<span class="text-danger">Something Went Wrong</span>')
              }
      });
    }
    //ON_DELETE
    function deletePost(user_id,titleId,titleContent){
        let token=$('#token').val();
           $('#edit_it').val('false');
           $('#delete_it').val('True')
           $.get('/api/forum',{csrf_token:token,blog_id:user_id,edit:1},function(data){
               confirm("Are You Sure you want to delete the post.");
              if(data.Message===true){
                $('#'+titleId).val(data.blog_title);
                $('#'+titleContent).text(data.blog_content)
                $("#postBlog").text('Delete Post')
                $("#delete_it").val("True")
                $("#blog_id").val(user_id)

              }else{
                $('#response-blog').html('<span class="text-danger">Something Went Wrong</span>')
              }
      });
    }
    function seeOtherPost(blogUserId, userFirstName) {
        $.get('/api/see_post/' + encodeURIComponent(blogUserId), { blog_id: blogUserId },function(data) {
            window.location.href='/api/see_post/' + encodeURIComponent(blogUserId)
    });
    }

function searchBlog(){
    $("#response-list").html("<div class=\"spinner-border text-primary\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div>");
    $.post("/api/search_blog",$("#formSearch").serialize(),function(data){
      var date,date_disp,iso_date;
      setTimeout(()=>{
      results=""
      if(data.length==""){
        results+="<li class='list-group-item'><a>No records found</a></li>"
      }else{
        for(var i=0;i<data.length;i++){
          iso_date=data[i].date_joined
          date = new Date(iso_date)
          
          date_disp=date.toISOString().slice(0,10);
        results+="<li class='list-group-item'><p>"+data[i].blog_title+"</p>|<p class='text-primary'>said by "+data[i].user_last_name+"</p><p>"+date_disp+"</p><a href=''>see blog</a></li>";
      }

      } 
      $("#response-list").html(results);},1500);
    })
  }
function loadChat(id,name,selforclick){
  $(".card-msg").css({"opacity":1})
  $(".card-msg").css({"animation":" 2s ease-in !important"})
  $('#message_headbar').text(name);
  var token=$("input[name='csrfmiddlewaretoken']").val();
  $.get("/api/chatLoad",{csrfmiddlewaretoken:token,id:id,pid:{{user_id.id}},selforclick:selforclick},function(response){
    if(response.message===true){
        var chat_list=response.data;
        var html_fk="";
        var html_hk="";
        chat_list.forEach(function(chat){
            var chatISO= chat.date_messaged;
            var UK_date= new Date(chatISO);
            if(chat.pid==={{user_id.id}}){
            
            
            html_hk+=`<p class="hk_user ">${chat.message}</p><i>${UK_date.toDateString()}</i>`;}
            else{
              html_fk+=`<p class="fk_user">${chat.message}</p><i>${UK_date.toDateString()}</i>`
            }
        })
        

        $("#fk_msg").html(html_fk);
          $("#hk_msg").html(html_hk);

        $(".fk_user").addClass("chat-bubble");
        $(".hk_user").addClass("chat-bubble")
        $("#fk_id").val(id);

    }else{
      alert("no messages yet");
    }
  })
}


function sendMessage(message){
    var message= $("#"+message).val();
    $('#home_usr').text(message);
    $(".home_user").addClass("message-out");
    
    var fk_id=$("#fk_id").val()

    var token=$("input[name='csrfmiddlewaretoken']").val();
    $.post("/api/chatLoad",{csrfmiddlewaretoken:token,fk_id:fk_id,message:message,id:{{user_id.id}}},function(response){
    if(response.message===true){
      loadChat(fk_id,"{{blog.user_id.first_name}}",'0')
      $("#mess_1").val("");
    }else{
      alert("no messages yet");
    }
  })
}
function toggle(){
$(".card-msg").css({"opacity":0});
}
function friends_list(){
  var token=$("input[name='csrfmiddlewaretoken']").val();
  $.get('/api/chat',{csrfmiddlewaretoken:token,id:{{user_id.id}}},function(friendsList){
    if(friendsList.message===true){
        var friend_list=friendsList.data
        var html="";
        friend_list.forEach(function(friends){
          if(friends.id!=={{user_id.id}}){
              dot=""
              if(friends.alive===1){
                dot+='online-green';
              }else{
                dot+='offline-red';
              }
              var  badgeHtml = "";
                    if (friends.msg_count > 0) {
                        // Added a class 'badge-counter' so you can style it red via CSS
                        badgeHtml = `<sup class=" badge  text-bg-danger" title='${friends.msg_count} Unread messages'>${friends.msg_count}</sup>`;
                    }
          html+=`<li class='list-group-item'><a onclick="loadChat('${friends.id}','${friends.first_name}','1')" style='cursor:pointer;' id='list_notf_${friends.id}'>${friends.first_name}<input type='hidden' value=${friends.id}><span class='${dot}'></span>
          ${badgeHtml}</a></li>`;
        }
        });
        $("#lst_grp").html(html);
    }else{
      $("#lst_grp").html("<p>No Users Founds </p>");
    }
  })
}
function loadFormModal(flag,notEdit){
  let token= $("input[name='csrfmiddlewaretoken']").val();
  if(flag==1){
    $.get('/api/bio',{id:{{user_id.id}},csrfmiddlewaretoken:token},function(data){
    if(data.message===true){
      console.log(data.data);
        var response = data.data; 
        var types = data.types;   
        var myFields = Object.keys(response).map(key => {
          console.log(response[key]);
        return {
              id: key,
              name: key,
              label: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 
              value: response[key],
              type: types ? types[key] : 'text' 
          };
      });
    const builder = new FormsBuild('user-bio-form', myFields,notEdit);
    document.getElementById('update-bio').innerHTML = builder.generate();
      
      }
    else{
      alert("something went wrong");
    }
    });

  }
}
function editFormLoad(flag){
  if(flag==1){
      $("#update-bio").html('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');
  setTimeout(()=>{
     loadFormModal(1,0);
  },2000);
  }
  else if(flag==2){
  let token= $("input[name='csrfmiddlewaretoken']").val();
  let email=$("#email").val();
  let first_name=$("#first_name").val();
  let last_name=$("#last_name").val();
  let gender=$("#gender").val();
  $.post('/api/bio',{csrfmiddlewaretoken:token,email:email,first_name:first_name,last_name:last_name,gender:gender,id:{{user_id.id}}},
  function(response){
    if(response.message==true){
      $("#output-bio").html(`<p class='alert alert-success'>${response.data}</p>`);
    }else{
      $("#output-bio").html(`<p class='alert alert-success'>${response.message}</p>`);
    }

  }); 

  }else{
  console.log("something went wrong");
 }
}
</script>
{% endblock page-script %}
